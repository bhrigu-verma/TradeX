<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>TraderX Settings</title>
  <link rel="stylesheet" href="settings.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
  <div class="app">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <span class="logo">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
            <polyline points="16 7 22 7 22 13"></polyline>
          </svg>
        </span>
        <span class="logo-text">TraderX Pro</span>
        <span class="version">v1.4</span>
      </div>

      <div class="nav-section">
        <div class="nav-label">Settings</div>
        <div class="nav-item active" data-tab="filters">
          <span class="nav-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
            </svg>
          </span>
          <span>Filters</span>
        </div>
        <div class="nav-item" data-tab="tiers">
          <span class="nav-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </span>
          <span>Account Tiers</span>
        </div>
        <div class="nav-item" data-tab="watchlist">
          <span class="nav-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
          </span>
          <span>Watchlist</span>
        </div>
        <div class="nav-item" data-tab="alerts">
          <span class="nav-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
          </span>
          <span>Alerts</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-label">Discover</div>
        <div class="nav-item" data-tab="suggested">
          <span class="nav-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
              </polygon>
            </svg>
          </span>
          <span>Suggested Follows</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-label">Advanced</div>
        <div class="nav-item" data-tab="display">
          <span class="nav-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
          </span>
          <span>Display</span>
        </div>
        <div class="nav-item" data-tab="data">
          <span class="nav-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </span>
          <span>Data &amp; Export</span>
        </div>
      </div>

      <div class="sidebar-footer">
        <button class="btn btn-primary btn-full" id="save-all">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Save All
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="content">
      <!-- FILTERS TAB -->
      <div class="tab-content active" id="tab-filters">
        <div class="page-header">
          <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
            </svg>
            Spam Filters
          </h1>
          <p>Control what content is hidden from your feed to reduce noise.</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Content Filters</h2>
            <div class="master-toggle" style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 12px; color: var(--text-secondary);">Enable All</span>
              <label class="toggle">
                <input type="checkbox" id="filter-master" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

          <div class="filter-grid">
            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Engagement Bait</span>
                <span class="filter-desc">"RT if you agree", "Like if..."</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="filter-engagement" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Promotional Content</span>
                <span class="filter-desc">Discord, Telegram, courses, giveaways</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="filter-promo" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Low-Effort Posts</span>
                <span class="filter-desc">Emoji spam, brief text, clutter</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="filter-low-effort" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Crypto Scams</span>
                <span class="filter-desc">Wallet drainers, airdrops, pump schemes</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="filter-crypto" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Disclaimers</span>
                <span class="filter-desc">NFA, DYOR, "not financial advice"</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="filter-disclaimers" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Market Hours Threads</span>
                <span class="filter-desc">Hide long threads during active trading</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="filter-threads" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Old News</span>
                <span class="filter-desc">Hide "yesterday" or "last week" content</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="filter-old-news" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Time-Sensitive Mode</span>
                <span class="filter-desc">Auto-adjust filters by market hours</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="filter-time-sensitive" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- TIERS TAB -->
      <div class="tab-content" id="tab-tiers">
        <div class="page-header">
          <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Account Tiers
          </h1>
          <p>Prioritize information from trusted sources. Tier 1 users are never filtered.</p>
        </div>

        <div class="card">
          <div class="tier-section">
            <div class="tier-header tier1">
              <span class="tier-badge" style="color: #FF2E63;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
              </span>
              <div class="tier-info">
                <span class="tier-title">Tier 1 - Critical</span>
                <span class="tier-desc">Red border ‚Ä¢ Never filtered ‚Ä¢ Official sources only</span>
              </div>
            </div>
            <textarea id="tier1-accounts" spellcheck="false"
              placeholder="One username per line (without @)&#10;Example:&#10;federalreserve&#10;secgov"></textarea>
          </div>

          <div class="tier-section">
            <div class="tier-header tier2">
              <span class="tier-badge" style="color: #FF9F1C;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </span>
              <div class="tier-info">
                <span class="tier-title">Tier 2 - Trusted</span>
                <span class="tier-desc">Orange border ‚Ä¢ Reliable analysts & news</span>
              </div>
            </div>
            <textarea id="tier2-accounts" spellcheck="false"
              placeholder="One username per line&#10;Example:&#10;unusual_whales&#10;deltaone"></textarea>
          </div>

          <div class="tier-section">
            <div class="tier-header tier3">
              <span class="tier-badge" style="color: #FFD93D;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
              </span>
              <div class="tier-info">
                <span class="tier-title">Tier 3 - Signals</span>
                <span class="tier-desc">Yellow border ‚Ä¢ Trading signals & noise</span>
              </div>
            </div>
            <textarea id="tier3-accounts" spellcheck="false"
              placeholder="One username per line&#10;Example:&#10;optionsflow&#10;tradingsetups"></textarea>
          </div>
        </div>
      </div>

      <!-- WATCHLIST TAB -->
      <div class="tab-content" id="tab-watchlist">
        <div class="page-header">
          <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
            Watchlist
          </h1>
          <p>Manage your tracked tickers for real-time highlighting.</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Add Tickers</h2>
          </div>
          <div class="input-row">
            <input type="text" id="add-ticker-input" placeholder="Enter ticker (e.g., AAPL, BTC, TSLA)">
            <button class="btn btn-success" id="add-ticker-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add
            </button>
          </div>

          <div class="watchlist-display" id="watchlist-display">
            <!-- Populated by JS -->
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Quick Add Popular</h2>
          </div>
          <div class="quick-tickers">
            <button class="quick-ticker" data-ticker="SPY">SPY</button>
            <button class="quick-ticker" data-ticker="QQQ">QQQ</button>
            <button class="quick-ticker" data-ticker="TSLA">TSLA</button>
            <button class="quick-ticker" data-ticker="NVDA">NVDA</button>
            <button class="quick-ticker" data-ticker="AAPL">AAPL</button>
            <button class="quick-ticker" data-ticker="BTC">BTC</button>
            <button class="quick-ticker" data-ticker="ETH">ETH</button>
            <button class="quick-ticker" data-ticker="AMD">AMD</button>
            <button class="quick-ticker" data-ticker="META">META</button>
            <button class="quick-ticker" data-ticker="GOOGL">GOOGL</button>
          </div>
        </div>
      </div>

      <!-- ALERTS TAB -->
      <div class="tab-content" id="tab-alerts">
        <div class="page-header">
          <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            Keyword Alerts
          </h1>
          <p>Get notified instantly when important keywords appear.</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Active Alert Rules</h2>
            <label class="toggle">
              <input type="checkbox" id="alerts-enabled" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="alert-rules" id="alert-rules">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <!-- SUGGESTED TAB -->
      <div class="tab-content" id="tab-suggested">
        <div class="page-header">
          <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon
                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
              </polygon>
            </svg>
            Suggested Follows
          </h1>
          <p>Curated list of top trading & finance accounts.</p>
        </div>

        <div class="card suggested-header-card" style="border-left: 3px solid var(--accent-primary);">
          <div style="display: flex; gap: 12px; align-items: start;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              style="color: var(--accent-primary); flex-shrink: 0;">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <div>
              <p style="font-size: 15px; margin-bottom: 6px; color: var(--text-primary); font-weight: 600;">
                Pre-configured Quality</p>
              <p class="text-muted" style="font-size: 13px;">These accounts are pre-added to your tiers. Tweets from
                these accounts will be highlighted and never filtered.</p>
            </div>
          </div>
        </div>

        <div id="suggested-categories">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- DISPLAY TAB -->
      <div class="tab-content" id="tab-display">
        <div class="page-header">
          <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            Display Settings
          </h1>
          <p>Customize the interface look and feel.</p>
        </div>

        <div class="card">
          <div class="filter-grid">
            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Show Price Sidebar</span>
                <span class="filter-desc">Live prices embedded on X.com</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="ui-sidebar" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Show Ticker Tags</span>
                <span class="filter-desc">BTC ‚Üë, TSLA ‚Üì badges on posts</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="ui-ticker-tags" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="filter-item">
              <div class="filter-info">
                <span class="filter-title">Show Tier Badges</span>
                <span class="filter-desc">CRITICAL, TRUSTED labels</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="ui-tier-badges" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

          <div class="setting-row"
            style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Price Refresh Interval</label>
            <div class="input-with-unit" style="display: flex; align-items: center; gap: 8px;">
              <input type="number" id="ui-refresh" min="15" max="300" value="30" style="width: 100px;">
              <span class="text-muted">seconds</span>
            </div>
          </div>
        </div>
      </div>

      <!-- DATA TAB -->
      <div class="tab-content" id="tab-data">
        <div class="page-header">
          <h1>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Data & Export
          </h1>
          <p>Backup or reset your configuration.</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h2>Export / Import</h2>
          </div>
          <div class="button-row" style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" id="export-settings">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              Export Settings
            </button>
            <button class="btn btn-secondary" id="import-settings">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Import Settings
            </button>
          </div>
          <input type="file" id="import-file" accept=".json" style="display: none;">
        </div>

        <div class="card card-danger">
          <div class="card-header">
            <h2 style="color: var(--danger);">Danger Zone</h2>
          </div>
          <button class="btn btn-danger" id="reset-settings">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Reset All Settings
          </button>
          <p class="text-muted" style="margin-top: 12px; font-size: 12px;">This will delete all your custom settings and
            cannot be undone.</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Status Toast -->
  <div class="toast" id="toast">
    <span id="toast-message">Saved!</span>
  </div>

  <!-- All scripts inlined for reliable execution in Chrome Extension context -->
  <script>
    // ============================================================================
    // UTILS.JS - Core configuration, helpers, and market utilities
    // ============================================================================

    const DEFAULT_CONFIG = {
      watchlist: ['SPY', 'QQQ', 'TSLA', 'NVDA', 'AAPL'],

      tiers: {
        tier1: [
          'federalreserve', 'secgov', 'treasury', 'sec_enforcement',
          'whitehouse', 'potus', 'fdadev'
        ],
        tier2: [
          'unusual_whales', 'DeItaone', 'FirstSquawk', 'financialjuice',
          'Newsquawk', 'zerohedge', 'Fxhedgers', 'SquawkCNBC',
          'charliebilello', 'sentimentrader', 'biabormarket',
          'Tradytics', 'spotgamma', 'optionabormarket',
          'traderstewie', 'WallStJesus', 'jimcramer'
        ],
        tier3: [
          'wallstreetbets', 'optionsflow', 'tradingsetups',
          'stocktwits', 'TrendSpider', 'OptionsPlay'
        ]
      },

      filters: {
        enableSpamFilter: true,
        enableWatchlistHighlight: true,
        enableTierColors: true,
        enableTimeSensitive: true,
        hideEngagementBait: true,
        hidePromo: true,
        hideLowEffort: true,
        hideCryptoScams: true,
        hideDisclaimers: true,
        hideLowFollowers: false,
        hideThreads: true,
        hideOldNews: true,
        minFollowers: 500
      },

      alerts: {
        enabled: true,
        sound: true,
        keywords: [
          { name: 'FDA', pattern: 'FDA approval|FDA approves|FDA reject', tickers: 'watchlist' },
          { name: 'Earnings', pattern: 'earnings beat|earnings miss|EPS', tickers: 'watchlist' },
          { name: 'Halts', pattern: 'trading halt|halted|circuit breaker', tickers: 'all' },
          { name: 'Mergers', pattern: 'merger|acquisition|buyout', tickers: 'watchlist' },
          { name: 'Short Report', pattern: 'short report|short seller|hindenburg|citron', tickers: 'all' }
        ]
      },

      ui: {
        showSidebar: true,
        priceRefreshSec: 30,
        sidebarPosition: 'right',
        compactMode: false
      },

      stats: {
        tweetsHidden: 0,
        alertsTriggered: 0,
        watchlistMentions: 0
      }
    };

    async function getConfig() {
      return new Promise((resolve) => {
        chrome.storage.local.get(['config'], (result) => {
          const config = result.config || {};
          const merged = deepMerge(JSON.parse(JSON.stringify(DEFAULT_CONFIG)), config);
          resolve(merged);
        });
      });
    }

    async function saveConfig(config) {
      return new Promise((resolve) => {
        chrome.storage.local.set({ config }, resolve);
      });
    }

    function deepMerge(target, source) {
      if (!source) return target;
      Object.keys(source).forEach(key => {
        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
          if (!target[key]) target[key] = {};
          deepMerge(target[key], source[key]);
        } else {
          target[key] = source[key];
        }
      });
      return target;
    }

    window.TraderXUtils = { DEFAULT_CONFIG, getConfig, saveConfig };

    // ============================================================================
    // SUGGESTED.JS - Curated trading & finance accounts
    // ============================================================================

    const SUGGESTED_HANDLES = {
      official: {
        title: "üèõÔ∏è Official & Government",
        handles: ["federalreserve", "secgov", "treasury", "whitehouse"]
      },
      news: {
        title: "üì∞ Breaking News & Headlines",
        handles: ["unusual_whales", "DeItaone", "FirstSquawk", "financialjuice", "Newsquawk", "zerohedge"]
      },
      macro: {
        title: "üåç Macro & Economics",
        handles: ["charliebilello", "sentimentrader"]
      },
      options: {
        title: "üìä Options & Flow",
        handles: ["Tradytics", "spotgamma"]
      },
      traders: {
        title: "üìà Active Traders",
        handles: ["traderstewie", "WallStJesus"]
      }
    };

    function getAllSuggestedHandles() {
      const all = [];
      Object.values(SUGGESTED_HANDLES).forEach(category => {
        all.push(...category.handles);
      });
      return [...new Set(all)];
    }

    window.TraderXSuggested = { SUGGESTED_HANDLES, getAllSuggestedHandles };

    console.log('[Suggested] Loaded', getAllSuggestedHandles().length, 'suggested handles');

    // ============================================================================
    // SETTINGS.JS - Settings page logic
    // ============================================================================

    let currentConfig = null;

    async function init() {
      console.log('[Settings] Initializing...');
      setupNavigation();

      if (typeof chrome === 'undefined' || !chrome.storage) {
        console.warn('[Settings] Chrome storage API not available - using defaults');
        currentConfig = DEFAULT_CONFIG;
        loadAllSettings();
        setupEventListeners();
        return;
      }

      try {
        currentConfig = await getConfig();
        console.log('[Settings] Config loaded:', currentConfig);
        loadAllSettings();
        setupEventListeners();
        console.log('[Settings] Initialized successfully');
      } catch (error) {
        console.error('[Settings] Initialization error:', error);
        currentConfig = DEFAULT_CONFIG;
        loadAllSettings();
        setupEventListeners();
      }
    }

    function loadAllSettings() {
      try {
        loadFilters();
        loadTiers();
        loadWatchlist();
        loadAlerts();
        loadSuggested();
        loadDisplay();
      } catch (error) {
        console.error('[Settings] Error loading settings:', error);
      }
    }

    function setupNavigation() {
      console.log('[Settings] Setting up navigation...');
      const navItems = document.querySelectorAll('.nav-item[data-tab]');
      console.log('[Settings] Found', navItems.length, 'navigation items');

      navItems.forEach((item, index) => {
        const tabId = item.dataset.tab;
        console.log('[Settings] Nav item ' + index + ': tab="' + tabId + '"');

        item.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('[Settings] Navigation clicked:', tabId);

          document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
          item.classList.add('active');

          document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
          const targetTab = document.getElementById('tab-' + tabId);
          if (targetTab) {
            targetTab.classList.add('active');
            console.log('[Settings] Switched to tab:', tabId);
          } else {
            console.error('[Settings] Tab not found:', 'tab-' + tabId);
          }
        });
      });

      console.log('[Settings] Navigation setup complete');
    }

    function loadFilters() {
      const f = currentConfig.filters || {};
      safeSetChecked('filter-engagement', f.hideEngagementBait ?? true);
      safeSetChecked('filter-promo', f.hidePromo ?? true);
      safeSetChecked('filter-low-effort', f.hideLowEffort ?? true);
      safeSetChecked('filter-crypto', f.hideCryptoScams ?? true);
      safeSetChecked('filter-disclaimers', f.hideDisclaimers ?? true);
      safeSetChecked('filter-threads', f.hideThreads ?? true);
      safeSetChecked('filter-old-news', f.hideOldNews ?? true);
      safeSetChecked('filter-time-sensitive', f.enableTimeSensitive ?? true);
    }

    function loadTiers() {
      const t = currentConfig.tiers || {};
      safeSetValue('tier1-accounts', (t.tier1 || []).join('\n'));
      safeSetValue('tier2-accounts', (t.tier2 || []).join('\n'));
      safeSetValue('tier3-accounts', (t.tier3 || []).join('\n'));
    }

    function loadWatchlist() {
      renderWatchlist();
    }

    function renderWatchlist() {
      const container = document.getElementById('watchlist-display');
      if (!container) return;

      const watchlist = currentConfig.watchlist || [];

      if (watchlist.length === 0) {
        container.innerHTML = '<p class="text-muted">No tickers in watchlist</p>';
        return;
      }

      container.innerHTML = watchlist.map(ticker =>
        '<div class="watchlist-tag" data-ticker="' + ticker + '">$' + ticker + '<span class="remove">√ó</span></div>'
      ).join('');

      container.querySelectorAll('.watchlist-tag').forEach(tag => {
        tag.addEventListener('click', () => {
          const ticker = tag.dataset.ticker;
          currentConfig.watchlist = currentConfig.watchlist.filter(t => t !== ticker);
          renderWatchlist();
        });
      });
    }

    function loadAlerts() {
      const container = document.getElementById('alert-rules');
      if (!container) return;

      const alerts = currentConfig.alerts?.keywords || [];
      safeSetChecked('alerts-enabled', currentConfig.alerts?.enabled ?? true);

      container.innerHTML = alerts.map((rule, i) =>
        '<div class="alert-rule"><div class="alert-rule-info"><span class="alert-rule-name">' + rule.name + '</span><span class="alert-rule-pattern">' + rule.pattern + '</span></div><label class="toggle"><input type="checkbox" data-rule="' + i + '" checked><span class="toggle-slider"></span></label></div>'
      ).join('');
    }

    async function loadSuggested() {
      const container = document.getElementById('suggested-categories');
      if (!container) return;

      try {
        const url = chrome.runtime.getURL('accounts.json');
        const response = await fetch(url);
        const data = await response.json();

        const categoryIcons = {
          'Macro_CentralBanks': 'üè¶',
          'Institutional_AssetMgmt': 'üèõÔ∏è',
          'Regulatory_Government': '‚öñÔ∏è',
          'Media_News': 'üì∞',
          'Wealth_ValueInvesting': 'üíé',
          'Trading_TechnicalAnalysis': 'üìà',
          'RealEstate_Housing': 'üè†',
          'Geopolitics_OSINT': 'üåç',
          'Crypto_DeFi': '‚Çø',
          'Forex': 'üí±',
          'Commodities': 'üõ¢Ô∏è',
          'Corporate_IR': 'üè¢',
          'VentureCapital': 'üöÄ'
        };

        const categoryNames = {
          'Macro_CentralBanks': 'Central Banks & Macro',
          'Institutional_AssetMgmt': 'Institutional Asset Management',
          'Regulatory_Government': 'Regulatory & Government',
          'Media_News': 'Financial News & Media',
          'Wealth_ValueInvesting': 'Value Investing & Wealth',
          'Trading_TechnicalAnalysis': 'Technical Analysis & Trading',
          'RealEstate_Housing': 'Real Estate & Housing',
          'Geopolitics_OSINT': 'Geopolitics & OSINT',
          'Crypto_DeFi': 'Crypto & DeFi',
          'Forex': 'Forex & Currencies',
          'Commodities': 'Commodities & Resources',
          'Corporate_IR': 'Corporate & Investor Relations',
          'VentureCapital': 'Venture Capital & Startups'
        };

        const styleEl = document.createElement('style');
        styleEl.textContent = '.signal-directory-header{background:linear-gradient(135deg,#6366F1 0%,#8B5CF6 100%);padding:24px;border-radius:12px;margin-bottom:24px;color:white}.signal-directory-title{font-size:24px;font-weight:700;margin-bottom:8px}.signal-directory-subtitle{font-size:14px;opacity:0.9}.category-card{background:var(--bg-surface);border:1px solid rgba(139,92,246,0.2);border-radius:12px;padding:20px;margin-bottom:24px;transition:all 0.3s ease}.category-card:hover{border-color:rgba(139,92,246,0.5);box-shadow:0 4px 12px rgba(139,92,246,0.1)}.category-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(139,92,246,0.1)}.category-icon{font-size:28px}.category-name{font-size:18px;font-weight:600;color:var(--text-primary);flex:1}.category-count{font-size:12px;color:var(--text-muted);background:rgba(139,92,246,0.1);padding:4px 12px;border-radius:12px}.accounts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}.account-card{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(139,92,246,0.05);border:1px solid rgba(139,92,246,0.1);border-radius:8px;text-decoration:none;color:var(--text-primary);transition:all 0.2s ease}.account-card:hover{background:rgba(139,92,246,0.15);border-color:rgba(139,92,246,0.3);transform:translateY(-2px);box-shadow:0 4px 8px rgba(139,92,246,0.2)}.account-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#6366F1,#8B5CF6);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:14px;flex-shrink:0;overflow:hidden}.account-avatar img{width:100%;height:100%;object-fit:cover}.account-info{flex:1;min-width:0}.account-handle{font-size:14px;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}';
        document.head.appendChild(styleEl);

        let html = '<div class="signal-directory-header"><div class="signal-directory-title">üì° Signal Directory</div><div class="signal-directory-subtitle">' + Object.keys(data.accounts).length + ' categories ‚Ä¢ ' + Object.values(data.accounts).flat().length + ' verified accounts</div></div>';

        Object.entries(data.accounts).forEach(([key, handles]) => {
          const icon = categoryIcons[key] || 'üìä';
          const name = categoryNames[key] || key.replace(/_/g, ' ');

          html += '<div class="category-card"><div class="category-header"><span class="category-icon">' + icon + '</span><span class="category-name">' + name + '</span><span class="category-count">' + handles.length + ' accounts</span></div><div class="accounts-grid">';

          handles.forEach(handle => {
            const cleanHandle = handle.replace('@', '');
            const initials = cleanHandle.substring(0, 2).toUpperCase();
            html += '<a href="https://x.com/' + cleanHandle + '" target="_blank" class="account-card" data-handle="' + cleanHandle + '"><div class="account-avatar" data-handle="' + cleanHandle + '"><img src="https://unavatar.io/twitter/' + cleanHandle + '" onerror="this.style.display=\'none\'; this.parentElement.textContent=\'' + initials + '\'" alt="' + cleanHandle + '"></div><div class="account-info"><div class="account-handle">@' + cleanHandle + '</div></div></a>';
          });

          html += '</div></div>';
        });

        container.innerHTML = html;
      } catch (error) {
        console.error('[Settings] Failed to load suggested accounts:', error);
        container.innerHTML = '<p class="text-muted">Failed to load suggested accounts.</p>';
      }
    }

    function loadDisplay() {
      const ui = currentConfig.ui || {};
      safeSetChecked('ui-sidebar', ui.showSidebar ?? true);
      safeSetChecked('ui-ticker-tags', ui.showTickerTags ?? true);
      safeSetChecked('ui-tier-badges', ui.showTierBadges ?? true);
      safeSetValue('ui-refresh', ui.priceRefreshSec || 30);
    }

    async function saveSettings() {
      console.log('[Settings] Saving settings...');

      currentConfig.filters = currentConfig.filters || {};
      currentConfig.filters.hideEngagementBait = safeGetChecked('filter-engagement');
      currentConfig.filters.hidePromo = safeGetChecked('filter-promo');
      currentConfig.filters.hideLowEffort = safeGetChecked('filter-low-effort');
      currentConfig.filters.hideCryptoScams = safeGetChecked('filter-crypto');
      currentConfig.filters.hideDisclaimers = safeGetChecked('filter-disclaimers');
      currentConfig.filters.hideThreads = safeGetChecked('filter-threads');
      currentConfig.filters.hideOldNews = safeGetChecked('filter-old-news');
      currentConfig.filters.enableTimeSensitive = safeGetChecked('filter-time-sensitive');
      currentConfig.filters.enableSpamFilter = true;
      currentConfig.filters.enableWatchlistHighlight = true;
      currentConfig.filters.enableTierColors = true;

      currentConfig.tiers = {
        tier1: parseTextarea('tier1-accounts'),
        tier2: parseTextarea('tier2-accounts'),
        tier3: parseTextarea('tier3-accounts')
      };

      currentConfig.ui = currentConfig.ui || {};
      currentConfig.ui.showSidebar = safeGetChecked('ui-sidebar');
      currentConfig.ui.showTickerTags = safeGetChecked('ui-ticker-tags');
      currentConfig.ui.showTierBadges = safeGetChecked('ui-tier-badges');
      currentConfig.ui.priceRefreshSec = parseInt(safeGetValue('ui-refresh')) || 30;

      currentConfig.alerts = currentConfig.alerts || {};
      currentConfig.alerts.enabled = safeGetChecked('alerts-enabled');

      if (saveConfig) {
        await saveConfig(currentConfig);
        console.log('[Settings] Settings saved');
      }

      showToast('Settings saved!');
    }

    function parseTextarea(id) {
      const text = safeGetValue(id);
      return text
        .split('\n')
        .map(s => s.trim().toLowerCase().replace(/^@/, ''))
        .filter(Boolean);
    }

    function safeSetChecked(id, value) {
      const el = document.getElementById(id);
      if (el) el.checked = value;
    }

    function safeGetChecked(id) {
      const el = document.getElementById(id);
      return el ? el.checked : false;
    }

    function safeSetValue(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value;
    }

    function safeGetValue(id) {
      const el = document.getElementById(id);
      return el ? el.value : '';
    }

    function addToTier2(handle) {
      currentConfig.tiers = currentConfig.tiers || {};
      currentConfig.tiers.tier2 = currentConfig.tiers.tier2 || [];

      const normalized = handle.toLowerCase().replace(/^@/, '');
      if (!currentConfig.tiers.tier2.includes(normalized)) {
        currentConfig.tiers.tier2.push(normalized);
        safeSetValue('tier2-accounts', currentConfig.tiers.tier2.join('\n'));
      }
    }

    function addTicker(ticker) {
      currentConfig.watchlist = currentConfig.watchlist || [];
      const normalized = ticker.toUpperCase().replace(/^\$/, '');

      if (!/^[A-Z]{1,10}$/.test(normalized)) return false;

      if (!currentConfig.watchlist.includes(normalized)) {
        currentConfig.watchlist.push(normalized);
        renderWatchlist();
        return true;
      }
      return false;
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      const messageEl = document.getElementById('toast-message');
      if (!toast || !messageEl) return;

      messageEl.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function setupEventListeners() {
      console.log('[Settings] Setting up event listeners...');

      const saveBtn = document.getElementById('save-all');
      if (saveBtn) {
        saveBtn.addEventListener('click', saveSettings);
      }

      const addTickerBtn = document.getElementById('add-ticker-btn');
      if (addTickerBtn) {
        addTickerBtn.addEventListener('click', () => {
          const input = document.getElementById('add-ticker-input');
          if (input && addTicker(input.value)) {
            showToast('Added $' + input.value.toUpperCase());
            input.value = '';
          }
        });
      }

      const addTickerInput = document.getElementById('add-ticker-input');
      if (addTickerInput) {
        addTickerInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const btn = document.getElementById('add-ticker-btn');
            if (btn) btn.click();
          }
        });
      }

      document.querySelectorAll('.quick-ticker').forEach(btn => {
        btn.addEventListener('click', () => {
          const ticker = btn.dataset.ticker;
          if (addTicker(ticker)) {
            showToast('Added $' + ticker);
          }
        });
      });

      const exportBtn = document.getElementById('export-settings');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          const blob = new Blob([JSON.stringify(currentConfig, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'traderx-settings.json';
          a.click();
          URL.revokeObjectURL(url);
          showToast('Settings exported!');
        });
      }

      const importBtn = document.getElementById('import-settings');
      const importFile = document.getElementById('import-file');
      if (importBtn && importFile) {
        importBtn.addEventListener('click', () => {
          importFile.click();
        });

        importFile.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const text = await file.text();
          try {
            const imported = JSON.parse(text);
            currentConfig = imported;
            if (saveConfig) await saveConfig(currentConfig);
            location.reload();
          } catch (err) {
            alert('Invalid settings file');
          }
        });
      }

      const resetBtn = document.getElementById('reset-settings');
      if (resetBtn) {
        resetBtn.addEventListener('click', async () => {
          if (confirm('Reset ALL settings? This cannot be undone.')) {
            if (typeof chrome !== 'undefined' && chrome.storage) {
              await chrome.storage.local.clear();
            }
            location.reload();
          }
        });
      }

      console.log('[Settings] Event listeners setup complete');
    }

    // Initialize
    console.log('[Settings] Script loaded, waiting for DOM...');

    function safeInit() {
      try {
        console.log('[Settings] safeInit running...');
        init();
        console.log('[Settings] safeInit completed successfully');
      } catch (error) {
        console.error('[Settings] Init failed with error:', error);
        try {
          setupNavigation();
          console.log('[Settings] Navigation setup completed (fallback)');
        } catch (navError) {
          console.error('[Settings] Navigation setup also failed:', navError);
        }
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', safeInit);
      console.log('[Settings] Waiting for DOMContentLoaded...');
    } else {
      console.log('[Settings] DOM already ready, calling safeInit...');
      safeInit();
    }
  </script>
</body>

</html>